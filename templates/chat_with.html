{% extends "base.html" %}
{% block title %}ä¸{{ target.name }}èŠå¤© - æŒä¸Šå®{% endblock %}
{% block content %}
<div class="row">
    <div class="col-md-4">
        <div class="list-group mb-3 shadow-sm p-2 bg-white rounded-3">
            {% for c in contacts %}
            <a href="{{ url_for('chat_with', contact_id=c.id) }}" class="list-group-item list-group-item-action {% if c.id == target.id %}active{% endif %} d-flex justify-content-between align-items-center gap-2">
                <div class="avatar">
                    {% if c.avatar %}
                        <img src="{{ c.avatar }}" alt="å¤´åƒ">
                    {% else %}
                        {{ c.name[0] }}
                    {% endif %}
                </div>
                <span class="fw-semibold">{{ c.name }}</span>
                {% if unread_counts[c.id] > 0 %}
                <span class="badge bg-danger rounded-pill ms-2">{{ unread_counts[c.id] }}</span>
                {% endif %}
            </a>
            {% endfor %}
        </div>
    </div>
    <div class="col-md-8 chat-main-area">
        <div class="border rounded chat-messages-container mb-2 bg-white shadow-sm position-relative">
            <!-- æ¶ˆæ¯æœç´¢åŠŸèƒ½ -->
            <div class="chat-search">
                <div class="input-group input-group-sm">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" placeholder="æœç´¢æ¶ˆæ¯...">
                </div>
            </div>
            
            <!-- èŠå¤©è®¾ç½®æŒ‰é’® -->
            <button type="button" class="chat-settings-btn" title="èŠå¤©è®¾ç½®">
                <i class="bi bi-gear-fill"></i>
            </button>
            
            <!-- æ¶ˆæ¯åˆ—è¡¨ -->
            <div id="chat-messages" class="chat-messages-list">
                {% for m in messages %}
                <div class="message-row {% if m.sender_id == sender_id %}justify-content-end{% else %}justify-content-start{% endif %} message-item" data-id="{{ m.id }}">
                    <div class="message-avatar avatar" title="{{ m.sender.name }}">
                        {% if m.sender.avatar %}
                            <img src="{{ m.sender.avatar }}" alt="å¤´åƒ">
                        {% else %}
                            {{ m.sender.name[0] }}
                        {% endif %}
                    </div>
                    <div class="message-bubble {% if m.sender_id == sender_id %}me{% else %}other{% endif %} message-bubble">
                        {% if m.is_recalled %}
                            <span class="text-muted">æ¶ˆæ¯å·²æ’¤å›</span>
                        {% else %}
                            <div>
                                {% if m.content %}<span>{{ m.content }}</span>{% endif %}
                                {% if m.file_path and m.file_type == 'image' %}
                                    <a href="/{{ m.file_path }}" target="_blank"><img src="/{{ m.file_path }}" alt="å›¾ç‰‡" class="chat-img"></a>
                                {% elif m.file_path %}
                                    <a href="/{{ m.file_path }}" target="_blank" class="ms-2">[æ–‡ä»¶]</a>
                                {% endif %}
                            </div>
                            <div class="message-meta">
                                {{ m.sender.name }} {{ m.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                                {% if m.sender_id == sender_id %}
                                    {% if m.is_read %}<span class="text-success ms-2">å¯¹æ–¹å·²è¯»</span>{% else %}<span class="text-secondary ms-2">å¯¹æ–¹æœªè¯»</span>{% endif %}
                                    {% if not m.is_recalled %}
                                    <button type="button" class="btn btn-link text-danger p-0 ms-2 recall-btn" title="æ’¤å›æ¶ˆæ¯" {% if m.is_read %}disabled{% endif %}>
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                    {% endif %}
                                    <!-- æ¶ˆæ¯çŠ¶æ€æŒ‡ç¤º -->
                                    <span class="message-status {% if m.is_read %}read{% elif m.is_delivered %}delivered{% else %}sent{% endif %}"></span>
                                {% endif %}
                            </div>
                            <!-- æ¶ˆæ¯ååº” -->
                            <div class="message-reactions">
                                <button class="message-reaction">ğŸ‘</button>
                                <button class="message-reaction">â¤ï¸</button>
                                <button class="message-reaction">ğŸ˜„</button>
                                <button class="message-reaction">ğŸ‘€</button>
                            </div>
                        {% endif %}
                        <!-- æ¶ˆæ¯æ“ä½œæŒ‰é’® -->
                        <div class="message-actions">
                            {% if m.sender_id == sender_id and not m.is_recalled %}
                                {% if not m.is_read %}
                                <button type="button" class="btn btn-sm btn-outline-danger recall-single-btn" data-id="{{ m.id }}">
                                    <i class="bi bi-x-circle"></i> æ’¤å›
                                </button>
                                {% endif %}
                                <button type="button" class="btn btn-sm btn-outline-secondary copy-btn" data-text="{{ m.content }}" title="å¤åˆ¶æ¶ˆæ¯">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% if not messages %}
                <div class="text-muted">æš‚æ— æ¶ˆæ¯ã€‚</div>
                {% endif %}
            </div>
            <!-- æ¶ˆæ¯æ’¤å›æç¤ºåŒºåŸŸ -->
            <div id="recall-notification" class="recall-notification d-none">
                å·²æ’¤å›æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œæ‚¨è¿˜æœ‰10ç§’å¯ä»¥ç¼–è¾‘æˆ–åˆ é™¤æ­¤æ¶ˆæ¯
            </div>
        </div>
        
        <!-- æ–‡ä»¶æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ -->
        <form method="post" enctype="multipart/form-data" class="chat-input-area mt-auto" id="chatForm">
            <div class="drop-zone mb-2" id="dropZone">
                <i class="bi bi-cloud-upload fs-3 text-muted"></i>
                <label for="fileInput" class="text-muted ms-2">æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</label>
                <input type="file" id="fileInput" name="file" class="form-control d-none" title="é€‰æ‹©è¦å‘é€çš„æ–‡ä»¶">
            </div>
            <div class="input-group">
                <textarea class="form-control" name="content" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..." id="msgInput"></textarea>
                <button type="button" class="btn btn-outline-primary px-3" id="fileSelectBtn" title="é€‰æ‹©æ–‡ä»¶">
                    <i class="bi bi-paperclip"></i>
                </button>
                <button type="submit" class="btn btn-primary px-4 fw-semibold">å‘é€</button>
            </div>
            <div class="mt-2">
                <span>è¡¨æƒ…ï¼š</span>
                <button type="button" class="btn btn-light btn-sm emoji-btn">ğŸ˜„</button>
                <button type="button" class="btn btn-light btn-sm emoji-btn">ğŸ˜‚</button>
                <button type="button" class="btn btn-light btn-sm emoji-btn">ğŸ˜¢</button>
                <button type="button" class="btn btn-light btn-sm emoji-btn">ğŸ‘</button>
                <button type="button" class="btn btn-light btn-sm emoji-btn">â¤ï¸</button>
            </div>
            <a href="{{ url_for('chat') }}" class="btn btn-link mt-2">è¿”å›è”ç³»äººåˆ—è¡¨</a>
        </form>
    </div>
</div>
<!-- æ’¤å›ç¡®è®¤å¯¹è¯æ¡† -->
<div class="recall-confirm" id="recallConfirm">
    <h6 class="mb-3">ç¡®å®šè¦æ’¤å›è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ</h6>
    <button type="button" class="btn btn-primary btn-sm" id="confirmRecallBtn">ç¡®è®¤</button>
    <button type="button" class="btn btn-secondary btn-sm" id="cancelRecallBtn">å–æ¶ˆ</button>
</div>
<script>
// åœ¨DOMåŠ è½½å®Œæˆåæ‰§è¡Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // è·å–æ‰€æœ‰éœ€è¦çš„å…ƒç´ 
    var chatBox = document.getElementById('chat-messages');
    if(chatBox) chatBox.scrollTop = chatBox.scrollHeight;
    
    // åˆå§‹åŒ–æ–‡ä»¶æ‹–æ‹½åŠŸèƒ½
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    
    // æ‹–æ‹½äº‹ä»¶å¤„ç†
    if(dropZone && fileInput) {
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if(e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ–‡ä»¶é¢„è§ˆåŠŸèƒ½
            }
        });
    }
    
    // ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æŒ‰é’®
    const fileSelectBtn = document.getElementById('fileSelectBtn');
    if(fileInput && fileSelectBtn) {
        fileSelectBtn.addEventListener('click', () => {
            fileInput.click();
        });
    }
    
    // æ¶ˆæ¯æ’¤å›å€’è®¡æ—¶é€šçŸ¥
    let recallTimeout;
    Array.from(document.getElementsByClassName('recall-btn')).forEach(function(btn){
        btn.onclick = function(){
            if(confirm('ç¡®å®šæ’¤å›è¯¥æ¶ˆæ¯ï¼Ÿ')){
                fetch('/chat/recall/' + btn.dataset.id, {method:'POST'})
                .then(r=>r.json()).then(data=>{
                    if(data.success) location.reload();
                });
            }
        }
    });
    
    // æ’¤å›é€šçŸ¥æ˜¾ç¤ºé€»è¾‘
    document.getElementById('msgInput').addEventListener('focus', () => {
        const notification = document.getElementById('recall-notification');
        if(notification && notification.classList.contains('d-none')) {
            notification.classList.remove('d-none');
            setTimeout(() => {
                notification.classList.add('d-none');
            }, 10000);
        }
    });
    
    // æ¶ˆæ¯ååº”åŠŸèƒ½
    Array.from(document.getElementsByClassName('message-reaction')).forEach(function(btn){
        btn.addEventListener('click', function() {
            this.classList.toggle('active');
            // è¿™é‡Œå¯ä»¥æ·»åŠ å‘æœåŠ¡å™¨å‘é€ååº”æ•°æ®çš„é€»è¾‘
        });
    });
    
    // æ¶ˆæ¯æ’¤å›æ–°åŠŸèƒ½
    const recallConfirm = document.getElementById('recallConfirm');
    let currentMessageId = null;
    
    // å¤„ç†å•ä¸ªæ¶ˆæ¯æ’¤å›æŒ‰é’®ç‚¹å‡»
    Array.from(document.getElementsByClassName('recall-single-btn')).forEach(function(btn){
        btn.addEventListener('click', function() {
            currentMessageId = this.dataset.id;
            recallConfirm.style.display = 'block';
            // 5ç§’åè‡ªåŠ¨éšè—ç¡®è®¤æ¡†
            setTimeout(() => {
                if (recallConfirm.style.display === 'block') {
                    recallConfirm.style.display = 'none';
                }
            }, 5000);
        });
    });
    
    // ç¡®è®¤æ’¤å›æŒ‰é’®ç‚¹å‡»
    document.getElementById('confirmRecallBtn').addEventListener('click', function() {
        if(currentMessageId) {
            fetch(`/chat/recall/${currentMessageId}`, {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    if(data.success) {
                        location.reload();
                    } else {
                        alert('æ’¤å›å¤±è´¥ï¼š' + data.message);
                    }
                });
        }
    });
    
    // å–æ¶ˆæ’¤å›æŒ‰é’®ç‚¹å‡»
    document.getElementById('cancelRecallBtn').addEventListener('click', function() {
        recallConfirm.style.display = 'none';
        currentMessageId = null;
    });
    
    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­æ’¤å›ç¡®è®¤æ¡†
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.recall-single-btn') && !e.target.closest('.recall-confirm')) {
            recallConfirm.style.display = 'none';
            currentMessageId = null;
        }
    });
});

// è¡¨æƒ…é€‰æ‹©åŠŸèƒ½
Array.from(document.getElementsByClassName('emoji-btn')).forEach(function(btn){
    btn.onclick = function(){
        var input = document.getElementById('msgInput');
        input.value += btn.textContent;
        input.focus();
    }
});

// å›è½¦å‘é€ï¼ŒShift+Enteræ¢è¡Œ
var msgInput = document.getElementById('msgInput');
if(msgInput) {
    msgInput.addEventListener('keydown', function(e) {
        if(e.key === 'Enter') {
            if(e.shiftKey) {
                // å…è®¸æ¢è¡Œ
                return;
            } else {
                e.preventDefault();
                // è§¦å‘è¡¨å•çš„åŸç”Ÿæäº¤ï¼Œä¿è¯æ–‡ä»¶èƒ½è¢«ä¸Šä¼ 
                document.getElementById('chatForm').requestSubmit();
            }
        }
    });
}
</script>
{% endblock %}